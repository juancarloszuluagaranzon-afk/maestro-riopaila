<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Riopaila Agr√≠cola ‚Äì Maestro de Suertes</title>
<style>
:root{--bg:#f7fafc;--accent:#0ea5a4;--header-bg:#e9eef0}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#0f172a}
header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--header-bg);position:sticky;top:0;z-index:10}
header img.logo{width:48px;height:48px;object-fit:contain}
header .title{font-size:1.1rem;font-weight:700}
header .update{font-size:0.85rem;color:#475569}
.container{padding:16px}
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;align-items:center}
input,button{padding:8px;border-radius:8px;border:1px solid #e6e9ee}
button.primary{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
button.primary:hover{opacity:0.9}
button.secondary{background:#64748b;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:0.85rem}
button.secondary:hover{opacity:0.9}
.table-wrap{overflow-x:auto;background:#fff;border-radius:8px;padding:8px}
table{border-collapse:collapse;width:100%;min-width:800px}
th,td{padding:8px;border-bottom:1px solid #eef2f7;white-space:nowrap;text-align:left;font-size:13px}
th{background:#fbfeff;position:sticky;top:0;font-weight:600}
.loading{text-align:center;padding:40px;color:#64748b}
.error{background:#fee;color:#c00;padding:12px;border-radius:8px;margin:16px}
.update-banner{background:#fef3c7;border-left:4px solid #f59e0b;padding:12px;margin-bottom:16px;border-radius:4px}
.update-banner button{margin-left:12px}
@media (max-width:600px){input,button{padding:6px;font-size:14px} th,td{padding:6px;font-size:12px}}
</style>
</head>
<body>
<header>
<img src="icon-192.png" class="logo" alt="logo" onerror="this.style.display='none'">
<div>
  <div class="title">Riopaila Agr√≠cola ‚Äì Maestro de Suertes</div>
  <div class="update">√öltima actualizaci√≥n: 28 de octubre de 2025</div>
</div>
</header>
<div class="container">
  <div id="updateBanner" class="update-banner" style="display:none">
    ‚ö†Ô∏è Hay una nueva versi√≥n disponible. 
    <button class="secondary" onclick="updateApp()">Actualizar ahora</button>
  </div>
  
  <div class="controls">
    <label>Buscar: <input id="searchInput" placeholder="Buscar..."></label>
    <button id="downloadCsv" class="primary">Descargar CSV</button>
    <button id="clearCache" class="secondary" title="Limpiar cach√© y recargar">üîÑ Limpiar Cach√©</button>
  </div>
  <div id="loadingMsg" class="loading">Cargando datos...</div>
  <div id="errorMsg" class="error" style="display:none"></div>
  <div class="table-wrap" style="display:none"><table id="maestro"><thead></thead><tbody></tbody></table></div>
  <div id="pagination" style="display:none;justify-content:center;align-items:center;gap:12px;margin:16px">
    <button id="prevPage" class="primary">‚Üê Anterior</button>
    <span id="pageInfo"></span>
    <button id="nextPage" class="primary">Siguiente ‚Üí</button>
  </div>
</div>
<script>
// Versi√≥n de la app - CAMBIAR ESTE N√öMERO CADA VEZ QUE ACTUALICES
const APP_VERSION = 'v1.2.0';
const CSV_FILE = 'maestro.csv';

let HEADERS = [];
let ROWS = [];
let currentPage = 1, pageSize = 25;

// Detectar si hay una nueva versi√≥n del Service Worker
let newWorkerWaiting = null;

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').then(reg => {
    reg.addEventListener('updatefound', () => {
      const newWorker = reg.installing;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          newWorkerWaiting = newWorker;
          document.getElementById('updateBanner').style.display = 'block';
        }
      });
    });
  }).catch(err => console.log('Service Worker no disponible:', err));
  
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    window.location.reload();
  });
}

function updateApp() {
  if (newWorkerWaiting) {
    newWorkerWaiting.postMessage({ type: 'SKIP_WAITING' });
  }
}

// Funci√≥n para limpiar cach√© manualmente
async function clearCache() {
  try {
    if ('serviceWorker' in navigator) {
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const registration of registrations) {
        await registration.unregister();
      }
    }
    
    if ('caches' in window) {
      const cacheNames = await caches.keys();
      await Promise.all(cacheNames.map(name => caches.delete(name)));
    }
    
    localStorage.clear();
    alert('Cach√© limpiado. La p√°gina se recargar√°.');
    window.location.reload(true);
  } catch (error) {
    console.error('Error al limpiar cach√©:', error);
    alert('Error al limpiar cach√©. Intenta cerrar y abrir la app de nuevo.');
  }
}

// Cargar el CSV con cache busting
async function loadCSV() {
  try {
    const cacheBuster = Date.now();
    console.log('Intentando cargar:', CSV_FILE);
    
    const response = await fetch(`${CSV_FILE}?v=${cacheBuster}`, {
      cache: 'no-store',
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      }
    });
    
    console.log('Response status:', response.status);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: No se pudo cargar el archivo CSV. Verifica que "${CSV_FILE}" est√© en el repositorio.`);
    }
    
    const text = await response.text();
    console.log('CSV cargado, tama√±o:', text.length, 'caracteres');
    
    if (!text || text.trim().length === 0) {
      throw new Error('El archivo CSV est√° vac√≠o');
    }
    
    const lines = text.split('\n').filter(line => line.trim());
    console.log('L√≠neas encontradas:', lines.length);
    
    if (lines.length === 0) {
      throw new Error('No se encontraron datos en el CSV');
    }
    
    // Primera l√≠nea son los headers
    HEADERS = lines[0].split(';').map(h => h.trim());
    console.log('Headers:', HEADERS.length, 'columnas');
    
    // El resto son los datos
    ROWS = lines.slice(1).map(line => {
      const values = line.split(';');
      while (values.length < HEADERS.length) values.push('');
      return values.slice(0, HEADERS.length).map(v => v.trim());
    });
    
    // Filtrar filas vac√≠as o con errores
    ROWS = ROWS.filter(row => row.some(cell => cell && cell !== '#¬°REF!'));
    console.log('Filas procesadas:', ROWS.length);
    
    if (ROWS.length === 0) {
      throw new Error('No se encontraron filas v√°lidas en el CSV');
    }
    
    document.getElementById('loadingMsg').style.display = 'none';
    document.querySelector('.table-wrap').style.display = 'block';
    document.getElementById('pagination').style.display = 'flex';
    
    localStorage.setItem('appVersion', APP_VERSION);
    localStorage.setItem('lastUpdate', new Date().toISOString());
    
    renderTable();
    console.log('Tabla renderizada correctamente');
    
  } catch (error) {
    console.error('Error completo:', error);
    document.getElementById('loadingMsg').style.display = 'none';
    const errorMsg = document.getElementById('errorMsg');
    errorMsg.innerHTML = `<strong>Error al cargar los datos:</strong><br>${error.message}<br><br>
      <small>Verifica que el archivo <code>${CSV_FILE}</code> est√© en la ra√≠z del repositorio de GitHub.<br>
      Si el problema persiste, presiona el bot√≥n "Limpiar Cach√©".</small>`;
    errorMsg.style.display = 'block';
  }
}

function renderTable() {
  const tbody = document.querySelector('#maestro tbody');
  const thead = document.querySelector('#maestro thead');
  const search = document.getElementById('searchInput').value.toLowerCase();
  
  const filtered = ROWS.filter(r => r.some(v => String(v||'').toLowerCase().includes(search)));
  const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
  if (currentPage > totalPages) currentPage = totalPages;
  
  const start = (currentPage - 1) * pageSize;
  const pageRows = filtered.slice(start, start + pageSize);
  
  thead.innerHTML = '<tr>' + HEADERS.map(h => '<th>' + h + '</th>').join('') + '</tr>';
  tbody.innerHTML = pageRows.map(r => '<tr>' + r.map(c => '<td>' + (c || '') + '</td>').join('') + '</tr>').join('');
  
  document.getElementById('pageInfo').innerText = `P√°gina ${currentPage} / ${totalPages} (${filtered.length} registros)`;
  document.getElementById('prevPage').disabled = currentPage <= 1;
  document.getElementById('nextPage').disabled = currentPage >= totalPages;
}

document.getElementById('searchInput').addEventListener('input', () => { currentPage = 1; renderTable(); });
document.getElementById('prevPage').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderTable(); } });
document.getElementById('nextPage').addEventListener('click', () => { currentPage++; renderTable(); });
document.getElementById('clearCache').addEventListener('click', clearCache);
document.getElementById('downloadCsv').addEventListener('click', () => {
  const sep = ',', lines = [HEADERS.join(sep)];
  ROWS.forEach(r => lines.push(r.map(c => '"' + String(c||'').replace(/"/g, '""') + '"').join(sep)));
  const blob = new Blob([lines.join('\n')], {type: 'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); 
  a.href = URL.createObjectURL(blob);
  a.download = 'Maestro_Riopaila_' + new Date().toISOString().split('T')[0] + '.csv'; 
  a.click();
});

// Verificar versi√≥n al cargar
const savedVersion = localStorage.getItem('appVersion');
if (savedVersion && savedVersion !== APP_VERSION) {
  console.log('Nueva versi√≥n detectada:', savedVersion, '->', APP_VERSION);
  localStorage.setItem('appVersion', APP_VERSION);
}

// Cargar datos
loadCSV();
</script>
</body>
</html>
