<!doctype html>
<html lang="es" class="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">
<title>Riopaila Agr√≠cola</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect">
<link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
<style>
.material-symbols-outlined {
  font-variation-settings: 'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24;
}
body {
  min-height: max(884px, 100dvh);
  font-family: 'Manrope', sans-serif;
}
@keyframes pulse-slow {
  0%,100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.9; }
}
.animate-pulse-slow { animation: pulse-slow 4s ease-in-out infinite; }

/* Estilos para el banner de instalaci√≥n */
.install-banner {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #0f172a;
  color: white;
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  z-index: 1000;
  max-width: 400px;
  width: 90%;
  text-align: center;
}
.install-banner button {
  background: #0ea5a4;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  margin: 0 4px;
  cursor: pointer;
}
.install-banner button.secondary {
  background: #64748b;
}
</style>
</head>

<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 flex flex-col items-center justify-center min-h-screen p-6 relative overflow-hidden">
  <!-- Fondo decorativo -->
  <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-teal-50 via-white to-slate-100 dark:from-slate-800 dark:via-slate-900 dark:to-black -z-10"></div>

  <!-- Banner de instalaci√≥n -->
  <div id="installBanner" class="install-banner" style="display:none">
    <div class="font-semibold mb-2">üì± Instalar App</div>
    <div class="text-sm text-slate-300 mb-3">Instala la aplicaci√≥n para uso offline</div>
    <button onclick="installApp()">Instalar</button>
    <button onclick="dismissInstall()" class="secondary">M√°s tarde</button>
  </div>

  <!-- Contenedor principal -->
  <main class="w-full max-w-lg text-center bg-white dark:bg-slate-800/70 backdrop-blur-lg rounded-2xl shadow-xl p-10 border border-slate-200 dark:border-slate-700 relative">
    
    <!-- Logo -->
    <div class="flex justify-center mb-6">
      <div class="w-28 h-28 rounded-full bg-gradient-to-tr from-teal-500 to-teal-300 flex items-center justify-center shadow-lg animate-pulse-slow">
        <img src="icon-192.png" alt="Riopaila Agr√≠cola" class="w-16 h-16">
      </div>
    </div>

    <h1 class="text-3xl font-extrabold tracking-tight mb-2 text-slate-900 dark:text-white">Riopaila Agr√≠cola</h1>
    <h2 class="text-lg font-medium text-slate-600 dark:text-slate-300 mb-3">Maestro de Suertes ¬∑ Transformaci√≥n Digital</h2>
    <span class="inline-block bg-teal-100 text-teal-700 dark:bg-teal-900/50 dark:text-teal-300 px-4 py-1 rounded-full text-sm font-semibold mb-8">üå± Innovando el campo</span>

    <!-- Estado de la instalaci√≥n -->
    <div id="installStatus" class="mb-6 p-4 bg-slate-100 dark:bg-slate-700 rounded-lg text-sm">
      <div class="flex items-center justify-center gap-2">
        <span id="statusIcon" class="material-symbols-outlined text-teal-500">sync</span>
        <span id="statusText">Verificando instalaci√≥n...</span>
      </div>
    </div>

    <!-- Botones principales -->
    <div class="flex flex-col gap-4">
      <button onclick="window.location.href='maestro.html'" class="w-full py-3 bg-gradient-to-r from-teal-600 to-teal-400 hover:from-teal-500 hover:to-teal-300 text-white font-bold rounded-lg shadow-md transition-transform hover:scale-[1.02]">
        üìã Abrir Maestro
      </button>

      <button onclick="clearCache()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-lg shadow transition-transform hover:scale-[1.02]">
        üîÑ Limpiar Cach√©
      </button>

      <button onclick="verifyInstallation()" class="w-full py-3 bg-amber-600 hover:bg-amber-500 text-white font-semibold rounded-lg shadow transition-transform hover:scale-[1.02]">
        üîç Verificar Instalaci√≥n
      </button>
    </div>

    <!-- Caracter√≠sticas -->
    <div class="mt-10 grid grid-cols-3 gap-4 text-center">
      <div class="flex flex-col items-center gap-2">
        <span class="material-symbols-outlined text-teal-500 text-3xl">bolt</span>
        <p class="text-sm font-semibold">R√°pido</p>
      </div>
      <div class="flex flex-col items-center gap-2">
        <span class="material-symbols-outlined text-teal-500 text-3xl">shield</span>
        <p class="text-sm font-semibold">Seguro</p>
      </div>
      <div class="flex flex-col items-center gap-2">
        <span class="material-symbols-outlined text-teal-500 text-3xl">devices</span>
        <p class="text-sm font-semibold">Offline</p>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="mt-6 text-center text-sm text-slate-500 dark:text-slate-400">
    ¬© 2025 Riopaila Agr√≠cola S.A.S. ‚Äî <span class="font-semibold text-teal-500">v1.7.6</span>
  </footer>

  <!-- Service Worker + Clear Cache -->
  <script>
// ==============================
// üîß CONFIGURACI√ìN
// ==============================
const APP_VERSION = 'v1.7.6';
const CACHE_NAME = 'riopaila-maestro-v1.7.5';
let deferredPrompt = null;

// ==============================
// üîß Registro del Service Worker MEJORADO
// ==============================
async function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    try {
      const registration = await navigator.serviceWorker.register('service-worker.js');
      console.log('[SW] Registrado correctamente:', registration.scope);
      
      // Verificar estado de la instalaci√≥n
      await verifyCacheStatus();
      
      // Escuchar actualizaciones (pero no forzar)
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            console.log('‚ö° Nueva versi√≥n disponible');
            showUpdateNotification();
          }
        });
      });

      return registration;
    } catch (err) {
      console.error('[SW] Error al registrar:', err);
      updateStatus('error', 'Error en la instalaci√≥n');
      return null;
    }
  } else {
    console.warn('[SW] Service Worker no soportado');
    updateStatus('warning', 'Navegador no compatible con modo offline');
    return null;
  }
}

// ==============================
// üì± VERIFICACI√ìN DE CACH√â
// ==============================
async function verifyCacheStatus() {
  try {
    console.log('üîç Verificando estado del cach√©...');
    
    const cache = await caches.open(CACHE_NAME);
    const keys = await cache.keys();
    const cachedFiles = keys.map(req => new URL(req.url).pathname.split('/').pop());
    
    console.log('üìÇ Archivos en cach√©:', cachedFiles);
    
    const essentialFiles = ['maestro.html', 'maestro.csv', 'service-worker.js'];
    const missingFiles = essentialFiles.filter(file => !cachedFiles.includes(file));
    
    if (missingFiles.length === 0) {
      updateStatus('success', 'App lista para uso offline');
      console.log('‚úÖ Todos los archivos esenciales est√°n en cach√©');
    } else {
      updateStatus('warning', `Faltan archivos: ${missingFiles.join(', ')}`);
      console.warn('‚ùå Archivos faltantes:', missingFiles);
    }
    
    return missingFiles.length === 0;
  } catch (err) {
    console.error('‚ùå Error verificando cach√©:', err);
    updateStatus('error', 'Error verificando instalaci√≥n');
    return false;
  }
}

// ==============================
// üìä ACTUALIZAR ESTADO EN UI
// ==============================
function updateStatus(type, message) {
  const statusIcon = document.getElementById('statusIcon');
  const statusText = document.getElementById('statusText');
  const statusDiv = document.getElementById('installStatus');
  
  statusText.textContent = message;
  
  // Limpiar clases anteriores
  statusDiv.className = 'mb-6 p-4 rounded-lg text-sm';
  statusIcon.className = 'material-symbols-outlined';
  
  switch(type) {
    case 'success':
      statusDiv.classList.add('bg-green-100', 'dark:bg-green-900');
      statusIcon.classList.add('text-green-500');
      statusIcon.textContent = 'check_circle';
      break;
    case 'warning':
      statusDiv.classList.add('bg-amber-100', 'dark:bg-amber-900');
      statusIcon.classList.add('text-amber-500');
      statusIcon.textContent = 'warning';
      break;
    case 'error':
      statusDiv.classList.add('bg-red-100', 'dark:bg-red-900');
      statusIcon.classList.add('text-red-500');
      statusIcon.textContent = 'error';
      break;
    default:
      statusDiv.classList.add('bg-slate-100', 'dark:bg-slate-700');
      statusIcon.classList.add('text-teal-500');
      statusIcon.textContent = 'sync';
  }
}

// ==============================
// üì± INSTALACI√ìN DE PWA
// ==============================
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  showInstallBanner();
});

function showInstallBanner() {
  const banner = document.getElementById('installBanner');
  banner.style.display = 'block';
}

function dismissInstall() {
  const banner = document.getElementById('installBanner');
  banner.style.display = 'none';
}

async function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    
    if (outcome === 'accepted') {
      console.log('‚úÖ Usuario acept√≥ la instalaci√≥n');
      updateStatus('success', 'App instalada correctamente');
    }
    
    deferredPrompt = null;
    dismissInstall();
  }
}

// ==============================
// üîÑ NOTIFICACI√ìN DE ACTUALIZACI√ìN
// ==============================
function showUpdateNotification() {
  if (confirm('¬°Nueva versi√≥n disponible! ¬øQuieres actualizar ahora?')) {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.ready.then(registration => {
        registration.active.postMessage({ type: 'SKIP_WAITING' });
      });
    }
  }
}

// ==============================
// üßπ LIMPIAR CACH√â MEJORADO
// ==============================
async function clearCache() {
  try {
    console.log('üßπ Iniciando limpieza de cach√©...');
    updateStatus('sync', 'Limpiando cach√©...');
    
    // 1. Desregistrar Service Workers
    if ('serviceWorker' in navigator) {
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const registration of registrations) {
        await registration.unregister();
        console.log('üóëÔ∏è Service Worker eliminado:', registration.scope);
      }
    }

    // 2. Eliminar todas las cach√©s
    if ('caches' in window) {
      const cacheNames = await caches.keys();
      await Promise.all(cacheNames.map(name => caches.delete(name)));
      console.log('üßæ Cach√©s eliminadas:', cacheNames);
    }

    // 3. Limpiar almacenamiento local
    localStorage.clear();
    sessionStorage.clear();

    console.log('‚úÖ Cach√© limpiado completamente');
    updateStatus('success', 'Cach√© limpiado correctamente');
    
    // 4. Recargar y reinstalar
    setTimeout(() => {
      if (confirm('‚úÖ Cach√© limpiado. Se recargar√° la p√°gina para reinstalar la app.')) {
        window.location.reload();
      }
    }, 1000);
    
  } catch (err) {
    console.error('‚ùå Error al limpiar cach√©:', err);
    updateStatus('error', 'Error al limpiar cach√©');
    alert('‚ö†Ô∏è Error al limpiar cach√©. Intenta cerrar y abrir el navegador.');
  }
}

// ==============================
// üîç VERIFICACI√ìN MANUAL
// ==============================
async function verifyInstallation() {
  updateStatus('sync', 'Verificando instalaci√≥n...');
  const isComplete = await verifyCacheStatus();
  
  if (isComplete) {
    // Forzar precarga de archivos esenciales
    await preloadEssentialFiles();
  }
}

// ==============================
// üì• PRECARGAR ARCHIVOS ESENCIALES
// ==============================
async function preloadEssentialFiles() {
  try {
    console.log('üì• Precargando archivos esenciales...');
    const filesToPreload = ['maestro.html', 'maestro.csv'];
    
    for (const file of filesToPreload) {
      try {
        await fetch(file);
        console.log(`‚úÖ Precargado: ${file}`);
      } catch (err) {
        console.warn(`‚ö†Ô∏è No se pudo precargar: ${file}`, err);
      }
    }
    
    console.log('‚úÖ Precarga completada');
  } catch (err) {
    console.error('‚ùå Error en precarga:', err);
  }
}

// ==============================
// üöÄ INICIALIZACI√ìN
// ==============================
async function initializeApp() {
  console.log('üöÄ Inicializando app...');
  
  // Registrar Service Worker
  await registerServiceWorker();
  
  // Verificar si estamos online/offline
  if (!navigator.onLine) {
    updateStatus('warning', 'Est√°s offline - Algunas funciones pueden no estar disponibles');
  }
  
  // Mostrar estado inicial
  setTimeout(() => {
    verifyCacheStatus();
  }, 2000);
}

// Iniciar cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', initializeApp);

// Escuchar cambios de conexi√≥n
window.addEventListener('online', () => {
  updateStatus('success', 'Conexi√≥n restaurada - App lista');
  verifyCacheStatus();
});

window.addEventListener('offline', () => {
  updateStatus('warning', 'Est√°s offline - Usando datos en cach√©');
});
  </script>
</body>
</html>
