// ==============================
// ğŸ”§ CONFIGURACIÃ“N
// ==============================
const APP_VERSION = 'v1.7.9'; // Coherente con SW
const CACHE_NAME = `riopaila-maestro-${APP_VERSION}`; // Corregido y dinÃ¡mico
let deferredPrompt = null;

// ==============================
// ğŸ”§ Registro del Service Worker
// ==============================
async function registerServiceWorker() {
  if (!('serviceWorker' in navigator)) {
    updateStatus('warning', 'Navegador no soporta modo offline.');
    return null;
  }
  
  try {
    updateStatus('sync', 'Instalando aplicaciÃ³n...');
    
    // Registrar el SW
    const registration = await navigator.serviceWorker.register('service-worker.js');
    console.log('[SW] Registrado correctamente:', registration.scope);
    
    // Si el SW estÃ¡ instalando, esperar que se active para verificar la cachÃ©
    if (registration.installing) {
      registration.installing.addEventListener('statechange', () => {
        if (registration.installing.state === 'activated') {
          console.log('[SW] Activado y listo.');
          verifyCacheStatus(); // Verificar despuÃ©s de activaciÃ³n
        }
      });
    } else {
      verifyCacheStatus(); // Si ya estaba activo, verificar inmediatamente
    }
    
    // Escuchar actualizaciones
    registration.addEventListener('updatefound', () => {
      const newWorker = registration.installing;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          showUpdateNotification(newWorker);
        }
      });
    });

    return registration;
  } catch (err) {
    console.error('[SW] Error al registrar:', err);
    updateStatus('error', 'Error en la instalaciÃ³n.');
    return null;
  }
}

// ==============================
// ğŸ“± VERIFICACIÃ“N DE CACHÃ‰ SIMPLIFICADA
// (ConfÃ­a en que el SW ya hizo su trabajo)
// ==============================
async function verifyCacheStatus() {
  try {
    console.log('ğŸ” Verificando estado final...');
    updateStatus('sync', 'Verificando cachÃ©...');

    // Esperar a que el SW tome control
    await navigator.serviceWorker.ready;
    
    // Verificar si el cachÃ© principal existe y tiene archivos
    const cache = await caches.open(CACHE_NAME);
    const keys = await cache.keys();
    
    // Asumimos Ã©xito si existe el cachÃ© y tiene mÃ¡s de 3 archivos esenciales
    if (keys.length > 3) {
      updateStatus('success', 'âœ… App lista para uso offline');
      console.log(`âœ… ${keys.length} archivos en cachÃ© (${CACHE_NAME})`);
    } else {
      updateStatus('warning', 'âš ï¸ InstalaciÃ³n incompleta. Recarga para intentar de nuevo.');
    }
  } catch (err) {
    console.error('âŒ Error verificando cachÃ©:', err);
    updateStatus('error', 'âŒ Error al acceder a cachÃ©.');
  }
}

// ==============================
// ğŸ“Š ACTUALIZAR ESTADO EN UI
// ==============================
function updateStatus(type, message) {
  // ImplementaciÃ³n UI idÃ©ntica a tu cÃ³digo original
  const statusIcon = document.getElementById('statusIcon');
  const statusText = document.getElementById('statusText');
  const statusDiv = document.getElementById('installStatus');
  
  statusText.textContent = message;
  
  statusDiv.className = 'mb-6 p-4 rounded-lg text-sm';
  statusIcon.className = 'material-symbols-outlined';
  
  switch(type) {
    case 'success':
      statusDiv.classList.add('bg-green-100', 'dark:bg-green-900');
      statusIcon.classList.add('text-green-500');
      statusIcon.textContent = 'check_circle';
      break;
    case 'warning':
      statusDiv.classList.add('bg-amber-100', 'dark:bg-amber-900');
      statusIcon.classList.add('text-amber-500');
      statusIcon.textContent = 'schedule';
      break;
    case 'error':
      statusDiv.classList.add('bg-red-100', 'dark:bg-red-900');
      statusIcon.classList.add('text-red-500');
      statusIcon.textContent = 'error';
      break;
    default:
      statusDiv.classList.add('bg-slate-100', 'dark:bg-slate-700');
      statusIcon.classList.add('text-teal-500');
      statusIcon.textContent = 'sync';
  }
}

// ==============================
// ğŸ“± INSTALACIÃ“N DE PWA
// ==============================
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  showInstallBanner();
});

function showInstallBanner() {
  document.getElementById('installBanner').style.display = 'block';
}

function dismissInstall() {
  document.getElementById('installBanner').style.display = 'none';
}

async function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    
    if (outcome === 'accepted') {
      updateStatus('success', 'App instalada correctamente');
    }
    
    deferredPrompt = null;
    dismissInstall();
  }
}

// ==============================
// ğŸ”„ NOTIFICACIÃ“N DE ACTUALIZACIÃ“N
// ==============================
function showUpdateNotification(newWorker) {
  const needsUpdate = confirm('Â¡Nueva versiÃ³n disponible! Â¿Quieres actualizar ahora?');
  
  if (needsUpdate) {
    // Si el usuario confirma, le pedimos al SW que salte la espera
    if (newWorker) {
      newWorker.postMessage({ type: 'SKIP_WAITING' });
    }
  }
}

// ==============================
// ğŸ§¹ LIMPIAR CACHÃ‰ (FunciÃ³n de emergencia)
// ==============================
async function clearCache() {
  try {
    //... (LÃ³gica de limpieza idÃ©ntica a tu cÃ³digo original)
    console.log('ğŸ§¹ Iniciando limpieza de cachÃ©...');
    updateStatus('sync', 'Limpiando cachÃ©...');
    
    // 1. Desregistrar Service Workers
    if ('serviceWorker' in navigator) {
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const registration of registrations) {
        await registration.unregister();
      }
    }

    // 2. Eliminar todas las cachÃ©s
    if ('caches' in window) {
      const cacheNames = await caches.keys();
      await Promise.all(cacheNames.map(name => caches.delete(name)));
    }

    // 3. Limpiar almacenamiento local
    localStorage.clear();
    sessionStorage.clear();
    
    updateStatus('success', 'âœ… CachÃ© limpiado completamente');
    
    setTimeout(() => {
      if (confirm('âœ… CachÃ© limpiado. Se recargarÃ¡ la pÃ¡gina para reinstalar la app.')) {
        window.location.reload();
      }
    }, 1000);
    
  } catch (err) {
    console.error('âŒ Error al limpiar cachÃ©:', err);
    updateStatus('error', 'âŒ Error al limpiar cachÃ©');
    alert('âš ï¸ Error al limpiar cachÃ©. Intenta cerrar y abrir el navegador.');
  }
}

// ==============================
// ğŸ” VERIFICACIÃ“N MANUAL
// ==============================
async function verifyInstallation() {
  updateStatus('sync', 'Verificando instalaciÃ³n...');
  await verifyCacheStatus();
}

// ==============================
// ğŸš€ INICIALIZACIÃ“N
// ==============================
document.addEventListener('DOMContentLoaded', () => {
  console.log('ğŸš€ Inicializando app...');
  
  if (!navigator.onLine) {
    updateStatus('warning', 'ğŸŒ EstÃ¡s offline - Usando datos en cachÃ©');
  }
  
  registerServiceWorker();
});

// Escuchar cambios de conexiÃ³n
window.addEventListener('online', () => {
  updateStatus('success', 'âœ… ConexiÃ³n restaurada - App lista');
  verifyCacheStatus();
});

window.addEventListener('offline', () => {
  updateStatus('warning', 'ğŸŒ EstÃ¡s offline - Usando datos en cachÃ©');
});
