<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Riopaila Agrícola – Maestro de Suertes</title>
<link rel="manifest" href="manifest.json">
<style>
  :root {
    --bg:#f7fafc;
    --accent:#0ea5a4;
    --header-bg:#e9eef0;
  }
  body {
    margin:0;
    font-family:Arial,Helvetica,sans-serif;
    background:var(--bg);
    color:#0f172a;
  }
  header {
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px 16px;
    background:var(--header-bg);
    position:sticky;
    top:0;
    z-index:10;
  }
  header img.logo { width:48px;height:48px;object-fit:contain; }
  header .title { font-size:1.1rem;font-weight:700; }
  header .update { font-size:0.85rem;color:#475569; }
  .container { padding:16px; }
  .controls { display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;align-items:center; }
  input,select,button { padding:8px;border-radius:8px;border:1px solid #e6e9ee; }
  button.primary { background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer; }
  .pill { background:#eef2ff;padding:6px 10px;border-radius:999px; }
  .table-wrap { overflow-x:auto;background:#fff;border-radius:8px;padding:8px; }
  table { border-collapse:collapse;width:100%; }
  th,td { padding:8px;border-bottom:1px solid #eef2f7;white-space:nowrap;text-align:left; }
  th { background:#fbfeff;position:sticky;top:0; }
  td.highlight { background:#f0f8f5;font-weight:600; }
  #splash { position:fixed;left:0;top:0;right:0;bottom:0;background:var(--header-bg);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999; }
  #splash.hidden { display:none; }
</style>
</head>
<body>
<div id="splash">
  <img src="icon-192.png" style="width:96px;height:96px">
  <h2>Riopaila Agrícola – Maestro de Suertes</h2>
</div>

<header>
  <img src="icon-192.png" class="logo" alt="logo">
  <div>
    <div class="title">Riopaila Agrícola – Maestro de Suertes</div>
    <div class="update">Última actualización: 30 de septiembre de 2025</div>
  </div>
</header>

<div class="container">
  <div class="controls">
    <label>Buscar texto: <input id="searchInput" placeholder="Buscar..."></label>
    <label>Columna: <select id="colSelect"></select></label>
    <label>Valor: <input id="colFilter" placeholder="Filtrar por columna"></label>
    <label>Filas por página: 
      <select id="pageSize">
        <option>10</option><option selected>25</option><option>50</option><option>100</option>
      </select>
    </label>
    <button id="downloadCsv" class="primary">Descargar CSV</button>
  </div>

  <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
    <div class="pill">Registros: <span id="totalCount">0</span></div>
    <div class="pill">Página: <span id="pageInfo">0 / 0</span></div>
  </div>

  <div class="table-wrap">
    <table id="maestro">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Controles de paginación -->
<div id="pagination" style="display:flex;justify-content:center;align-items:center;gap:12px;margin:16px;">
  <button id="prevPage" class="primary">← Anterior</button>
  <span id="paginationInfo"></span>
  <button id="nextPage" class="primary">Siguiente →</button>
</div>

<script>
// Registrar el service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}

// Ocultar splash
setTimeout(()=>document.getElementById('splash').classList.add('hidden'),1500);

// ==== DATOS EMBEBIDOS ====
const HEADERS = [];  // Se llenará dinámicamente desde CSV embebido
const ROWS = [];     // Igual

// Simulación de datos cargados (tu CSV embebido debe ir aquí)
fetch('MAESTRO_SEPT_25.csv')
  .then(r=>r.text())
  .then(text=>{
    const lines = text.trim().split('\n').map(l=>l.split(';'));
    HEADERS.push(...lines[0]);
    ROWS.push(...lines.slice(1));
    initTable();
  });

// ==== FUNCIONES ====
function parseDateFlexible(s){ if(!s) return null; s=String(s).trim().replace(/\//g,'-'); const p=s.split(' ')[0].split('-'); if(p.length!==3) return null; if(p[0].length===4) return new Date(p[0],p[1]-1,p[2]); if(p[2].length===4) return new Date(p[2],p[1]-1,p[0]); return null; }
function calcularEdadMesesDecimal(siembra,corte){ const hoy=new Date(); const fSi=parseDateFlexible(siembra); const fCo=parseDateFlexible(corte); if(!fSi && !fCo) return ""; const inicio = (fSi && fCo) ? (fSi>fCo?fSi:fCo) : (fSi||fCo); const years=hoy.getFullYear()-inicio.getFullYear(); const months=hoy.getMonth()-inicio.getMonth(); const days=hoy.getDate()-inicio.getDate(); const total=years*12+months+days/30; return total.toFixed(2); }

function initTable(){
  const thead = document.querySelector('#maestro thead');
  const tbody = document.querySelector('#maestro tbody');
  const colSelect = document.getElementById('colSelect');

  // Calcular columna de edad
  const idxEdad = HEADERS.indexOf("EDAD HOY MESES");
  const idxSiembra = HEADERS.indexOf("FECHA DE SIEMBRA");
  const idxCorte = HEADERS.indexOf("FECHA DE ULTIMO CORTE");
  const insertPos = idxEdad>=0?idxEdad+1:HEADERS.length;
  HEADERS.splice(insertPos,0,"EDAD HOY MESES (CALCULADA)");
  for(let i=0;i<ROWS.length;i++){
    const si=idxSiembra>=0?ROWS[i][idxSiembra]:"";
    const co=idxCorte>=0?ROWS[i][idxCorte]:"";
    ROWS[i].splice(insertPos,0,calcularEdadMesesDecimal(si,co));
  }

  HEADERS.forEach((h,i)=>{
    const opt=document.createElement('option');
    opt.value=i;
    opt.textContent=h;
    colSelect.appendChild(opt);
  });

  renderTable();
}

// ==== PAGINACIÓN ====
let currentPage=1;
function renderTable(){
  const tbody=document.querySelector('#maestro tbody');
  const pageSize=parseInt(document.getElementById('pageSize').value);
  const search=document.getElementById('searchInput').value.toLowerCase();
  const col=document.getElementById('colSelect').value;
  const colFilter=document.getElementById('colFilter').value.toLowerCase();
  
  // Filtrar
  const filtered = ROWS.filter(r=>{
    const matchSearch = search ? r.some(v=>String(v||'').toLowerCase().includes(search)) : true;
    const matchCol = col && colFilter ? String(r[col]||'').toLowerCase().includes(colFilter) : true;
    return matchSearch && matchCol;
  });

  const total=filtered.length;
  const totalPages=Math.max(1,Math.ceil(total/pageSize));
  if(currentPage>totalPages) currentPage=totalPages;
  const start=(currentPage-1)*pageSize;
  const pageRows=filtered.slice(start,start+pageSize);

  document.querySelector('#maestro thead').innerHTML='<tr>'+HEADERS.map(h=>`<th>${h}</th>`).join('')+'</tr>';
  tbody.innerHTML=pageRows.map(r=>'<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>').join('');

  document.getElementById('totalCount').textContent=total;
  document.getElementById('pageInfo').textContent=`${currentPage} / ${totalPages}`;
  document.getElementById('paginationInfo').textContent=`Mostrando ${start+1}–${Math.min(start+pageSize,total)} de ${total} registros`;

  document.getElementById('prevPage').disabled=currentPage===1;
  document.getElementById('nextPage').disabled=currentPage===totalPages;
}

document.getElementById('searchInput').addEventListener('input',()=>{currentPage=1;renderTable();});
document.getElementById('colFilter').addEventListener('input',()=>{currentPage=1;renderTable();});
document.getElementById('pageSize').addEventListener('change',()=>{currentPage=1;renderTable();});
document.getElementById('prevPage').addEventListener('click',()=>{if(currentPage>1){currentPage--;renderTable();}});
document.getElementById('nextPage').addEventListener('click',()=>{currentPage++;renderTable();});

// Descargar CSV
document.getElementById('downloadCsv').addEventListener('click',()=>{
  const sep=';';
  const lines=[HEADERS.join(sep)];
  ROWS.forEach(r=>{lines.push(r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(sep));});
  const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='Maestro_Riopaila.csv';
  a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
