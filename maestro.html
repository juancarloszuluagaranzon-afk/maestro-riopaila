<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Riopaila Agr√≠cola ‚Äì Maestro de Suertes</title>
<style>
:root {
  --bg:#f7fafc;
  --accent:#0ea5a4;
  --header-bg:#e9eef0;
}
body {
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg);
  color:#0f172a;
}
header {
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px 16px;
  background:var(--header-bg);
  position:sticky;
  top:0;
  z-index:10;
}
header img.logo {
  width:48px;
  height:48px;
  object-fit:contain;
  cursor:pointer;
}
header .title {
  font-size:1.1rem;
  font-weight:700;
}
header .update {
  font-size:0.85rem;
  color:#475569;
}
.container {
  padding:16px;
}
.controls {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:12px;
  align-items:center;
}
input {
  padding:8px;
  border-radius:8px;
  border:1px solid #e6e9ee;
  flex:1;
  min-width:200px;
}
.table-wrap {
  overflow-x:auto;
  background:#fff;
  border-radius:8px;
  padding:8px;
}
table {
  border-collapse:collapse;
  width:100%;
  min-width:900px;
}
th, td {
  padding:8px;
  border-bottom:1px solid #eef2f7;
  white-space:nowrap;
  text-align:left;
  font-size:13px;
}
th {
  background:#fbfeff;
  position:sticky;
  top:0;
  font-weight:600;
}
.loading {
  text-align:center;
  padding:40px;
  color:#64748b;
}
.error {
  background:#fee;
  color:#c00;
  padding:12px;
  border-radius:8px;
  margin:16px;
}

/* üî∞ SOMBREADO VERDE PARA LA COLUMNA DE EDAD */
td.edad-col {
  background:#d9fbe5 !important;
  font-weight:600;
  color:#065f46;
}

th.edad-col {
  background:#bbf7d0 !important;
  color:#065f46;
  font-weight:700;
}
</style>
</head>

<body>
<header>
  <a href="index.html" title="Volver al inicio">
    <img src="icon-192.png" class="logo" alt="logo">
  </a>
  <div>
    <div class="title">Riopaila Agr√≠cola ‚Äì Maestro de Suertes</div>
    <div class="update">√öltima actualizaci√≥n: 11 de noviembre de 2025</div>
  </div>
</header>

<div class="container">

  <div class="controls">
    <label>Buscar: <input id="searchInput" placeholder="Buscar..."></label>
  </div>

  <div id="loadingMsg" class="loading">Cargando datos...</div>
  <div id="errorMsg" class="error" style="display:none"></div>

  <div class="table-wrap" style="display:none">
    <table id="maestro">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="pagination" style="display:none;justify-content:center;align-items:center;gap:12px;margin:16px">
    <button id="prevPage">‚Üê Anterior</button>
    <span id="pageInfo"></span>
    <button id="nextPage">Siguiente ‚Üí</button>
  </div>

</div>

<script>
/* ==============================
   CONFIGURACI√ìN
============================== */
const CSV_FILE = "maestro.csv";
let HEADERS = [];
let ROWS = [];
let currentPage = 1;
const pageSize = 25;

/* ==============================
   FUNCI√ìN PARA CALCULAR EDAD
============================== */
function calcularEdad(fechaSiembra, fechaUltimoCorte) {
  if (!fechaSiembra && !fechaUltimoCorte) return "";

  const hoy = new Date();

  let dSiembra = fechaSiembra ? new Date(fechaSiembra) : null;
  let dUltimo   = fechaUltimoCorte ? new Date(fechaUltimoCorte) : null;

  let baseFecha;

  // ‚ö° L√ìGICA SOLICITADA:
  // Si √∫ltimo corte es mayor que siembra ‚Üí usar √∫ltimo
  if (dUltimo && dSiembra && dUltimo > dSiembra) {
    baseFecha = dUltimo;
  } else {
    baseFecha = dSiembra;
  }

  if (!baseFecha || isNaN(baseFecha.getTime())) return "";

  let meses =
    (hoy.getFullYear() - baseFecha.getFullYear()) * 12 +
    (hoy.getMonth() - baseFecha.getMonth());

  if (meses < 0) meses = 0;

  return meses;
}
/* ==============================
   CARGA Y PARSEO DEL CSV
============================== */
async function loadCSV() {
  try {
    const response = await fetch(CSV_FILE + "?v=" + Date.now());
    const text = await response.text();

    const lines = text.split("\n").filter(l => l.trim() !== "");

    // Detectar separador
    const sep = lines[0].includes(";") ? ";" : ",";

    HEADERS = lines[0].split(sep).map(h => h.trim());
    ROWS = lines
      .slice(1)
      .map(line => line.split(sep).map(v => v.trim()));

    // üìù Insertar columna "Edad" en la posici√≥n #5 (√≠ndice 4)
    HEADERS.splice(4, 0, "Edad (meses)");

    // Procesar filas con c√°lculo de edad
    ROWS = ROWS.map(r => {
      const fechaSiembra = r[3];   // Asumido col 4
      const fechaUltimo = r[4];    // Asumido col 5

      const edad = calcularEdad(fechaSiembra, fechaUltimo);

      r.splice(4, 0, edad); // Insertar edad en columna #5

      return r;
    });

    document.getElementById("loadingMsg").style.display = "none";
    document.querySelector(".table-wrap").style.display = "block";
    document.getElementById("pagination").style.display = "flex";

    renderTable();

  } catch (err) {
    console.error("Error cargando CSV:", err);
    document.getElementById("loadingMsg").textContent = "Error cargando archivo.";
  }
}

/* ==============================
   RENDER DE LA TABLA
============================== */
function renderTable() {
  const tbody = document.querySelector("#maestro tbody");
  const thead = document.querySelector("#maestro thead");

  const search = document.getElementById("searchInput").value.toLowerCase();

  const filtered = ROWS.filter(r =>
    r.some(v => String(v).toLowerCase().includes(search))
  );

  const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
  if (currentPage > totalPages) currentPage = totalPages;

  const start = (currentPage - 1) * pageSize;
  const pageRows = filtered.slice(start, start + pageSize);

  // === ENCABEZADOS ===
  thead.innerHTML =
    "<tr>" +
    HEADERS.map((h, idx) =>
      idx === 4
        ? `<th class="edad-col">${h}</th>`
        : `<th>${h}</th>`
    ).join("") +
    "</tr>";

  // === FILAS ===
  tbody.innerHTML = pageRows
    .map(r => {
      return (
        "<tr>" +
        r
          .map((c, idx) =>
            idx === 4
              ? `<td class="edad-col">${c}</td>`
              : `<td>${c}</td>`
          )
          .join("") +
        "</tr>"
      );
    })
    .join("");

  document.getElementById("pageInfo").textContent =
    `P√°gina ${currentPage} / ${totalPages} (${filtered.length} registros)`;

  document.getElementById("prevPage").disabled = currentPage <= 1;
  document.getElementById("nextPage").disabled = currentPage >= totalPages;
}

/* ==============================
   EVENTOS
============================== */
document.getElementById("searchInput").addEventListener("input", () => {
  currentPage = 1;
  renderTable();
});

document.getElementById("prevPage").addEventListener("click", () => {
  if (currentPage > 1) {
    currentPage--;
    renderTable();
  }
});

document.getElementById("nextPage").addEventListener("click", () => {
  currentPage++;
  renderTable();
});

/* ==============================
   INICIAR
============================== */
loadCSV();

</script>
</body>
</html>
