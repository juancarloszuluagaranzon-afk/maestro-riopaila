<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Riopaila Agr√≠cola ‚Äì Maestro de Suertes</title>
<style>
:root {
  --bg:#f7fafc;
  --accent:#0ea5a4;
  --header-bg:#e9eef0;
  --edad-bg:#d1fae5; /* Verde claro */
  --edad-text:#065f46; /* Verde oscuro */
}
body {
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg);
  color:#0f172a;
}
header {
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px 16px;
  background:var(--header-bg);
  position:sticky;
  top:0;
  z-index:10;
}
header img.logo {
  width:48px;
  height:48px;
  object-fit:contain;
  cursor:pointer;
}
header .title {
  font-size:1.1rem;
  font-weight:700;
}
header .update {
  font-size:0.85rem;
  color:#475569;
}
.container {
  padding:16px;
}
.controls {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:12px;
  align-items:center;
}
input {
  padding:8px;
  border-radius:8px;
  border:1px solid #e6e9ee;
  flex:1;
  min-width:200px;
}
.table-wrap {
  overflow-x:auto;
  background:#fff;
  border-radius:8px;
  padding:8px;
}
table {
  border-collapse:collapse;
  width:100%;
  min-width:800px;
}
th, td {
  padding:8px;
  border-bottom:1px solid #eef2f7;
  white-space:nowrap;
  text-align:left;
  font-size:13px;
}
th {
  background:#fbfeff;
  position:sticky;
  top:0;
  font-weight:600;
}
.edad-cell {
  background: var(--edad-bg);
  color: var(--edad-text);
  font-weight: bold;
}
.loading {
  text-align:center;
  padding:40px;
  color:#64748b;
}
.error {
  background:#fee;
  color:#c00;
  padding:12px;
  border-radius:8px;
  margin:16px;
}
.update-banner {
  background:#fef3c7;
  border-left:4px solid #f59e0b;
  padding:12px;
  margin-bottom:16px;
  border-radius:4px;
}
.offline-banner {
  background:#f0f9ff;
  border-left:4px solid #0ea5e9;
  padding:12px;
  margin-bottom:16px;
  border-radius:4px;
}
.update-banner button, .error button {
  margin-left:12px;
  background:var(--accent);
  color:white;
  border:none;
  padding:6px 10px;
  border-radius:6px;
  cursor:pointer;
}
</style>
</head>

<body>
<header>
  <a href="index.html" title="Volver al inicio">
    <img src="icon-192.png" class="logo" alt="logo">
  </a>
  <div>
    <div class="title">Riopaila Agr√≠cola ‚Äì Maestro de Suertes</div>
    <div class="update">√öltima actualizaci√≥n: 11 de noviembre de 2025</div>
  </div>
</header>

<div class="container">
  <div id="updateBanner" class="update-banner" style="display:none">
    ‚ö†Ô∏è Hay una nueva versi√≥n disponible. 
    <button onclick="updateApp()">Actualizar ahora</button>
  </div>

  <div id="offlineBanner" class="offline-banner" style="display:none">
    üì° <strong>Modo offline:</strong> Mostrando datos en cach√©.
  </div>

  <div class="controls">
    <label>Buscar: <input id="searchInput" placeholder="Buscar..."></label>
  </div>

  <div id="loadingMsg" class="loading">Cargando datos...</div>
  <div id="errorMsg" class="error" style="display:none"></div>

  <div class="table-wrap" style="display:none">
    <table id="maestro">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="pagination" style="display:none;justify-content:center;align-items:center;gap:12px;margin:16px">
    <button id="prevPage">‚Üê Anterior</button>
    <span id="pageInfo"></span>
    <button id="nextPage">Siguiente ‚Üí</button>
  </div>
</div>

<script>
const CSV_FILE = 'maestro.csv';
let HEADERS = [];
let ROWS = [];
let currentPage = 1;
let pageSize = 25;

/* ============================================================
   FUNCI√ìN: calcular meses entre fecha y hoy
   ============================================================ */
function mesesDesde(fechaStr) {
  if (!fechaStr) return null;

  // Normalizar: DD/MM/YYYY ‚Üí YYYY-MM-DD
  let parts;
  if (fechaStr.includes('/')) parts = fechaStr.split('/');
  else if (fechaStr.includes('-')) parts = fechaStr.split('-');
  else return null;

  if (parts.length !== 3) return null;

  const [d, m, y] = parts.map(n => parseInt(n));
  if (!y || !m || !d) return null;

  const fecha = new Date(y, m - 1, d);
  if (isNaN(fecha.getTime())) return null;

  const hoy = new Date();
  let meses =
    (hoy.getFullYear() - fecha.getFullYear()) * 12 +
    (hoy.getMonth() - fecha.getMonth());

  if (hoy.getDate() < fecha.getDate()) meses -= 1;
  return Math.max(meses, 0);
}

/* ============================================================
   FUNCI√ìN: cargar y procesar CSV
   ============================================================ */
function parseCSV(text) {
  const lines = text.split('\n').filter(l => l.trim());
  const sep = lines[0].includes(';') ? ';' : ',';

  HEADERS = lines[0].split(sep).map(h => h.trim());

  // Quitar columna EDAD del CSV si existe
  const edadIndex = HEADERS.findIndex(h =>
    h.toLowerCase().includes('edad')
  );
  if (edadIndex >= 0) HEADERS.splice(edadIndex, 1);

  // A√±adir nuestra columna calculada
  HEADERS.push('Edad a hoy (meses)');

  ROWS = lines.slice(1).map(line => {
    const cols = line.split(sep).map(c => c.trim());

    // Quitar EDAD original si exist√≠a
    if (edadIndex >= 0) cols.splice(edadIndex, 1);

    // Tomar fechas
    const siembra = cols[HEADERS.indexOf('SIEMBRA')] || null;
    const corte = cols[HEADERS.indexOf('ULTIMO_CORTE')] || null;

    const mSiembra = mesesDesde(siembra);
    const mCorte = mesesDesde(corte);

    // Regla de c√°lculo
    let edadHoy = 0;
    if (mSiembra !== null && mCorte !== null)
      edadHoy = Math.max(mSiembra, mCorte);
    else if (mCorte !== null)
      edadHoy = mCorte;
    else if (mSiembra !== null)
      edadHoy = mSiembra;

    cols.push(String(edadHoy ?? ''));

    return cols;
  });

  document.getElementById('loadingMsg').style.display = 'none';
  document.querySelector('.table-wrap').style.display = 'block';
  document.getElementById('pagination').style.display = 'flex';

  renderTable();
}
/* ============================================================
   RENDER DE TABLA (incluye color verde en columna de edad)
   ============================================================ */
function renderTable() {
  const tbody = document.querySelector('#maestro tbody');
  const thead = document.querySelector('#maestro thead');
  const search = document.getElementById('searchInput').value.toLowerCase();

  const filtered = ROWS.filter(r =>
    r.some(v => String(v || '').toLowerCase().includes(search))
  );

  const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage - 1) * pageSize;
  const pageRows = filtered.slice(start, start + pageSize);

  // Render encabezado
  thead.innerHTML = '<tr>' + HEADERS.map(h => `<th>${h}</th>`).join('') + '</tr>';

  // √çndice de la nueva columna ‚ÄúEdad a hoy (meses)‚Äù
  const edadIndex = HEADERS.indexOf('Edad a hoy (meses)');

  // Render filas
  tbody.innerHTML = pageRows
    .map(row => {
      return (
        '<tr>' +
        row
          .map((c, i) => {
            // Si es la columna de edad, aplicar fondo verde
            if (i === edadIndex) {
              return `<td class="edad-cell">${c}</td>`;
            }
            return `<td>${c}</td>`;
          })
          .join('') +
        '</tr>'
      );
    })
    .join('');

  document.getElementById('pageInfo').innerText =
    `P√°gina ${currentPage} / ${totalPages} (${filtered.length} registros)`;

  document.getElementById('prevPage').disabled = currentPage <= 1;
  document.getElementById('nextPage').disabled = currentPage >= totalPages;
}

/* ============================================================
   EVENTOS DE INTERFAZ
   ============================================================ */
document.getElementById('searchInput').addEventListener('input', () => {
  currentPage = 1;
  renderTable();
});
document.getElementById('prevPage').addEventListener('click', () => {
  if (currentPage > 1) {
    currentPage--;
    renderTable();
  }
});
document.getElementById('nextPage').addEventListener('click', () => {
  const totalPages = Math.max(1, Math.ceil(ROWS.length / pageSize));
  if (currentPage < totalPages) {
    currentPage++;
    renderTable();
  }
});

/* ============================================================
   MANEJO DE ERRORES Y REINTENTOS
   ============================================================ */
function showError(message) {
  document.getElementById('loadingMsg').style.display = 'none';
  const div = document.getElementById('errorMsg');
  div.style.display = 'block';
  div.innerHTML = `
    <strong>Error:</strong> ${message}<br>
    <small>Verifica la conexi√≥n o el archivo maestro.</small><br><br>
    <button onclick="location.reload()">Reintentar</button>
  `;
}

/* ============================================================
   CARGA DEL CSV DESDE RED O CACHE
   ============================================================ */
async function loadCSV() {
  try {
    const response = await fetch(`${CSV_FILE}?v=${Date.now()}`, {
      cache: 'no-store'
    });

    if (!response.ok) throw new Error('No se pudo cargar desde red');

    const text = await response.text();
    if (!text.trim()) throw new Error('Archivo CSV vac√≠o');

    parseCSV(text);
    console.log('CSV cargado desde red');
  } catch (err) {
    console.warn('Fallo al cargar desde red ‚Üí intentando cach√©‚Ä¶');

    try {
      const cached = await caches.match(CSV_FILE);
      if (!cached) throw new Error('CSV no existe en cach√©');

      const text = await cached.text();
      parseCSV(text);
      console.log('CSV cargado desde cach√©');
    } catch (err2) {
      showError('No se pudo cargar maestro.csv ni desde red ni desde cach√©.');
    }
  }
}

/* ============================================================
   VERIFICACI√ìN B√ÅSICA DE CACHE (opcional)
   ============================================================ */
async function verifyInstallation() {
  try {
    const cacheNames = await caches.keys();
    console.log('Cach√©s:', cacheNames);

    for (const name of cacheNames) {
      const c = await caches.open(name);
      const keys = await c.keys();
      console.log(`Archivos en cach√© [${name}]:`, keys.map(k => k.url));
    }
  } catch (err) {
    console.error('Error verificando cach√©:', err);
  }
}

/* ============================================================
   INICIALIZACI√ìN
   ============================================================ */
document.addEventListener('DOMContentLoaded', () => {
  loadCSV();
});

/* ============================================================
   CAMBIOS DE CONEXI√ìN
   ============================================================ */
window.addEventListener('online', () => {
  document.getElementById('offlineBanner').style.display = 'none';
});
window.addEventListener('offline', () => {
  document.getElementById('offlineBanner').style.display = 'block';
});

</script>
</body>
</html>
