<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Riopaila Agrícola – Maestro de Suertes</title>

<style>
:root {
  --bg:#f7fafc;
  --accent:#0ea5a4;
  --header-bg:#e9eef0;
  --edad-bg:#d1fae5;
}
body {
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg);
  color:#0f172a;
}
header {
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px 16px;
  background:var(--header-bg);
  position:sticky;
  top:0;
  z-index:10;
}
header img.logo {
  width:48px;
  height:48px;
  object-fit:contain;
  cursor:pointer;
}
header .title {
  font-size:1.1rem;
  font-weight:700;
}
header .update {
  font-size:0.85rem;
  color:#475569;
}
.container {
  padding:16px;
}
.controls {
  display:flex;
  gap:10px;
  margin-bottom:12px;
  flex-wrap:wrap;
}
input {
  padding:8px;
  border-radius:8px;
  border:1px solid #e6e9ee;
  flex:1;
  min-width:200px;
}
.table-wrap {
  overflow-x:auto;
  background:#fff;
  border-radius:8px;
  padding:8px;
}
table {
  border-collapse:collapse;
  width:100%;
  min-width:900px;
}
th, td {
  padding:8px;
  border-bottom:1px solid #eef2f7;
  white-space:nowrap;
  text-align:left;
  font-size:13px;
}
th {
  background:#fbfeff;
  position:sticky;
  top:0;
  font-weight:600;
}
.edad-cell {
  background:var(--edad-bg) !important;
  font-weight:bold;
}
.loading {
  text-align:center;
  padding:40px;
  color:#64748b;
}
.error {
  background:#fee;
  color:#c00;
  padding:12px;
  border-radius:8px;
  margin:16px;
}
</style>
</head>

<body>
<header>
  <a href="index.html">
    <img src="icon-192.png" class="logo" alt="logo">
  </a>
  <div>
    <div class="title">Riopaila Agrícola – Maestro de Suertes</div>
    <div class="update">Última actualización: 11 de noviembre de 2025</div>
  </div>
</header>

<div class="container">

  <div class="controls">
    <label>Buscar: <input id="searchInput" placeholder="Buscar..."></label>
  </div>

  <div id="loadingMsg" class="loading">Cargando datos...</div>
  <div id="errorMsg" class="error" style="display:none"></div>

  <div class="table-wrap" style="display:none">
    <table id="maestro">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="pagination" style="display:none;justify-content:center;align-items:center;gap:12px;margin:16px">
    <button id="prevPage">← Anterior</button>
    <span id="pageInfo"></span>
    <button id="nextPage">Siguiente →</button>
  </div>
</div>

<script>
const CSV_FILE = 'maestro.csv';

let HEADERS = [];
let ROWS = [];
let currentPage = 1;
let pageSize = 25;

// =========================
// CARGA DEL CSV
// =========================
async function loadCSV() {
  try {
    const res = await fetch(`${CSV_FILE}?v=${Date.now()}`, { cache:"no-store" });
    const text = await res.text();
    parseCSV(text);
  } catch (err) {
    showError("No se pudo cargar maestro.csv");
  }
}

function showError(msg){
  document.getElementById("loadingMsg").style.display="none";
  const div = document.getElementById("errorMsg");
  div.style.display="block";
  div.innerHTML = msg;
}

// =========================
// PARSE DEL CSV + CÁLCULO DE EDAD
// =========================
function parseCSV(text){
  const lines = text.split("\n").filter(x => x.trim());
  const sep = lines[0].includes(";") ? ";" : ",";
  HEADERS = lines[0].split(sep).map(h => h.trim());

  // ▼ Insertar EDAD como columna #5
  HEADERS.splice(4, 0, "EDAD HOY MESES");

  ROWS = lines.slice(1).map(line => {
    let cols = line.split(sep).map(c => c.trim());

    // EXTRAER CAMPOS PARA EL CÁLCULO
    const variedad = cols[HEADERS.indexOf("VARIEDAD") - 1]; 
    const siembra = cols[HEADERS.indexOf("FECHA DE SIEMBRA") - 1];
    const ultimo = cols[HEADERS.indexOf("FECHA DE ULTIMO CORTE") - 1];

    const edadMeses = calcularEdad(variedad, siembra, ultimo);

    // INSERTAR LA EDAD COMO COLUMNA #5
    cols.splice(4, 0, edadMeses);

    return cols;
  });

  document.querySelector(".table-wrap").style.display="block";
  document.getElementById("pagination").style.display="flex";
  document.getElementById("loadingMsg").style.display="none";

  renderTable();
}

// =========================
// FUNCIÓN DE CÁLCULO DE EDAD
// =========================
function calcularEdad(variedad, fSiembra, fUltimo) {
  if (!fSiembra) return "";
  if (variedad && variedad.toUpperCase() === "RENOVACION") return "0";

  const hoy = new Date();
  const fechaSiembra = new Date(fSiembra);
  const fechaUltimo = fUltimo ? new Date(fUltimo) : null;

  const meses = 365.25 / 12;

  let edad = 0;

  if (fechaUltimo && fechaUltimo > fechaSiembra) {
    edad = (hoy - fechaUltimo) / (1000 * 60 * 60 * 24 * meses);
  } else {
    edad = (hoy - fechaSiembra) / (1000 * 60 * 60 * 24 * meses);
  }

  edad = Math.max(0, Math.round(edad));
  return edad.toString();
}

// =========================
// RENDER TABLA
// =========================
function renderTable(){
  const tbody = document.querySelector("#maestro tbody");
  const thead = document.querySelector("#maestro thead");

  const search = document.getElementById("searchInput").value.toLowerCase();
  const filtered = ROWS.filter(r => r.some(c => (c||"").toLowerCase().includes(search)));

  const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
  if (currentPage > totalPages) currentPage = totalPages;

  const start = (currentPage-1)*pageSize;
  const pageRows = filtered.slice(start, start+pageSize);

  thead.innerHTML =
    "<tr>" + HEADERS.map(h => `<th>${h}</th>`).join("") + "</tr>";

  tbody.innerHTML = pageRows.map(row => {
    return "<tr>" +
      row.map((c,i) =>
        i === 4
        ? `<td class="edad-cell">${c}</td>`
        : `<td>${c}</td>`
      ).join("") +
    "</tr>";
  }).join("");

  document.getElementById("pageInfo").innerText =
    `Página ${currentPage} / ${totalPages} (${filtered.length} registros)`;

  document.getElementById("prevPage").disabled = (currentPage <= 1);
  document.getElementById("nextPage").disabled = (currentPage >= totalPages);
}

// =========================
// EVENTOS
// =========================
document.getElementById("searchInput").addEventListener("input", ()=> {
  currentPage = 1;
  renderTable();
});

document.getElementById("prevPage").addEventListener("click",()=>{
  if(currentPage>1){ currentPage--; renderTable(); }
});

document.getElementById("nextPage").addEventListener("click",()=>{
  currentPage++; renderTable();
});

// =========================
// INICIO
// =========================
loadCSV();
</script>
</body>
</html>
